/*
  tags: advanced

  <p>This example demonstrates rendering screen space projected lines
  from a technique described <a href="https://mattdesl.svbtle.com/drawing-lines-is-hard">here</a>.</p>

  <p>This technique requires each vertex to reference the previous and next vertex in the line;
  this example utilizes attribute byte offsets to share a single position buffer for all three
  of these attributes.</p>
*/
const { push, unshift } = Array.prototype;

function lineMesh(num) {
	let buffer = [];
	for (let i = 0; i < (num - 1) * 2; i += 2) {
		buffer.push(i, i + 1, i + 2, i + 2, i + 1, i + 3);
	}
	return buffer;
}

const buffer = {
	duplicate(buffer, stride, dupScale) {
		if (stride == null) stride = 1;
		if (dupScale == null) dupScale = 1;
		const out = [];
		const component = new Array(stride * 2);
		for (let i = 0, il = buffer.length / stride; i < il; i++) {
			const index = i * stride;
			for (let j = 0; j < stride; j++) {
				const value = buffer[index + j];
				component[j] = value;
				component[j + stride] = value * dupScale;
			}
			push.apply(out, component);
		}
		return out;
	},

	pushElement(buffer, elementIndex, stride) {
		const component = new Array(stride);
		const ai = elementIndex * stride;
		for (let i = 0; i < stride; i++) {
			component[i] = buffer[ai + i];
		}
		push.apply(buffer, component);
		return buffer;
	},

	unshiftElement(buffer, elementIndex, stride) {
		const component = new Array(stride);
		const ai = elementIndex * stride;
		for (let i = 0; i < stride; i++) {
			component[i] = buffer[ai + i];
		}
		unshift.apply(buffer, component);
		return buffer;
	},
};

const FLOAT_BYTES = Float32Array.BYTES_PER_ELEMENT;

const canvas = document.createElement("canvas");
canvas.width = 800;
canvas.height = 600;
document.body.appendChild(canvas);

const regl = wrapREGL({
	canvas: canvas,
	pixelRatio: 1,
	attributes: { antialias: false, preserveDrawingBuffer: true },
});

const positions = [
	285.3223137697517, 206.79688641194775, 286.23024830699774, 206.79688641194775, 288.0361173814898,
	206.79688641194775, 293.45372460496617, 206.79688641194775, 302.4830699774266, 204.090121027156,
	308.803611738149, 201.3833556423642, 316.0270880361174, 201.3833556423642, 325.95936794582394,
	202.28561077062813, 333.1828442437924, 207.69914154021166, 335.8916478555305, 217.62394795111481,
	335.8916478555305, 230.25551974680977, 335.8916478555305, 240.18032615771293, 332.2799097065463,
	246.4961120555604, 323.25056433408577, 250.10513256861606, 311.51241534988714, 250.10513256861606,
	297.9683972911964, 249.20287744035215, 287.13318284424383, 243.78934667076862, 278.1038374717833,
	229.35326461854584, 270.8803611738149, 210.40590692500342, 269.0744920993228, 192.36080435972497,
	269.0744920993228, 174.3157017944465, 271.783295711061, 158.97736461395982, 282.6185101580136,
	150.85706845958453, 300.67720090293454, 148.15030307479273, 319.6388261851016, 147.2480479465288,
	337.6975169300226, 147.2480479465288, 356.65914221218964, 150.85706845958453, 372.0090293453725,
	158.97736461395982, 385.55304740406325, 169.80442615312688, 397.2911963882618, 186.94727359014144,
	401.8058690744921, 208.60139666847562, 402.7088036117382, 231.1577748750737, 402.7088036117382,
	253.71415308167178, 393.67945823927766, 271.75925564695024, 376.52370203160274,
	284.39082744264516, 357.5620767494357, 292.51112359702046, 330.4740406320542, 300.6314197513958,
	296.1625282167043, 306.94720564924324, 267.26862302483073, 307.84946077750715, 250.11286681715575,
	306.94720564924324, 232.95711060948082, 299.72916462313185, 215.8013544018059, 275.3682761600059,
	197.74266365688487, 224.8419889772262, 184.19864559819413, 176.12021205097437, 178.7810383747178,
	154.4660889726402, 175.16930022573362, 143.63902743347313, 175.16930022573362, 131.9097107660421,
	178.7810383747178, 121.08264922687505, 195.03386004514672, 111.15784281597189, 235.66591422121897,
	101.23303640506873, 298.8713318284424, 96.72176076374912, 369.3002257336343, 96.72176076374912,
	439.7291196388262, 101.23303640506873, 496.61399548532734, 111.15784281597189, 529.1196388261851,
	126.49617999645858, 545.3724604966139, 149.9548133313206, 558.9164785553048, 182.4359979488218,
	572.4604966139955, 216.72169282285088, 584.1986455981942, 251.00738769687996, 593.2279909706547,
	288.9021030839648, 595.9367945823927, 323.18779795799384, 595.9367945823927, 352.9622171907033,
	589.6162528216704, 375.5185953973014, 567.0428893905191, 398.0749736038995, 536.3431151241534,
	416.12007616917793, 492.0993227990971, 422.4358620670254, 418.058690744921, 429.6539030931368,
	344.92099322799095, 434.1651787344564, 288.9390519187359, 434.1651787344564, 241.08352144469524,
	434.1651787344564, 204.96613995485328, 432.3606684779286, 178.78103837471784, 426.94713770834505,
	159.8194130925508, 416.12007616917793, 143.5665914221219, 399.8794838604273, 125.5079006772009,
	382.7366364234128, 109.25507900677201, 367.3982992429261, 96.61399548532731, 351.1577069341755,
	83.06997742663657, 334.01485949716096, 66.81715575620767, 313.2629915470907, 55.98194130925508,
	289.80435821222875, 53.27313769751693, 269.95474539042243, 49.66139954853273, 245.59385692729646,
	46.04966139954853, 217.62394795111481, 45.146726862302486, 199.57884538583636, 46.95259593679458,
	188.7517838466693, 53.27313769751693, 177.02246717923828, 64.10835214446952, 166.19540564007121,
	80.36117381489842, 153.5638338443763, 104.74040632054177, 139.1277517921535, 129.1196388261851,
	122.88715948340288, 155.30474040632055, 103.9398017898605, 176.97516930022573, 92.2104851224295,
	186.90744920993228, 86.79695435284597, 196.83972911963883, 83.18793383979028, 209.4808126410835,
	77.77440307020672, 222.12189616252823, 72.36087230062319, 234.7629796839729, 69.65410691583142,
	248.30699774266367, 66.94734153103965, 260.0451467268623, 65.14283127451179, 273.58916478555307,
	62.43606588972003, 288.0361173814898, 58.827045376664344, 300.67720090293454, 56.12027999187257,
	321.4446952595937, 54.31576973534473, 345.82392776523704, 53.413514607080806, 364.78555304740405,
	53.413514607080806, 381.941309255079, 53.413514607080806, 395.48532731376974, 53.413514607080806,
	409.93227990970655, 53.413514607080806, 427.08803611738153, 54.31576973534473, 444.24379232505646,
	57.92479024840041, 459.5936794582393, 62.43606588972003, 474.04063205417606, 69.65410691583142,
	487.5846501128668, 76.87214794194281, 502.0316027088036, 80.4811684549985, 524.6049661399549,
	89.50371973763774, 546.27539503386, 101.23303640506873, 566.1399548532731, 113.86460820076366,
	583.2957110609482, 125.59392486819465, 593.2279909706547, 134.61647615083388, 602.2573363431152,
	145.44353769000097, 609.4808126410835, 156.27059922916806, 616.7042889390519, 166.19540564007121,
	623.9277652370204, 177.9247223075022, 629.3453724604966, 191.45854923146106, 634.7629796839728,
	207.69914154021166, 639.2776523702032, 227.54875436201797, 643.7923250564334, 250.10513256861606,
	646.5011286681715, 270.8570005186863, 646.5011286681715, 285.29308257090906, 646.5011286681715,
	300.6314197513958, 646.5011286681715, 315.06750180361854, 646.5011286681715, 324.9923082145217,
	645.5981941309255, 335.81936975368876, 641.0835214446952, 349.3531966776476, 634.7629796839728,
	361.9847684733425, 630.2483069977427, 371.90957488424567, 623.9277652370204, 380.9321261668849,
	614.8984198645599, 389.9546774495242, 597.7426636568848, 402.58624924521905, 575.1693002257337,
	416.12007616917793, 553.4988713318285, 425.14262745181713, 533.6343115124154, 431.4584133496646,
	516.4785553047404, 436.87194411924816, 496.61399548532734, 440.4809646323039, 476.74943566591423,
	444.08998514535955, 459.5936794582393, 447.6990056584152, 445.14672686230244, 449.50351591494314,
	436.11738148984193, 450.40577104320704, 427.9909706546275, 450.40577104320704, 418.961625282167,
	451.30802617147094, 408.1264108352144, 452.21028129973485, 397.2911963882618, 452.21028129973485,
	389.1647855530474, 452.21028129973485, 381.941309255079, 452.21028129973485, 376.52370203160274,
	452.21028129973485, 372.0090293453725, 452.21028129973485, 368.39729119638827, 452.21028129973485,
	363.88261851015807, 452.21028129973485, 357.5620767494357, 452.21028129973485, 350.3386004514673,
	452.21028129973485, 341.3092550790068, 452.21028129973485, 329.5711060948081, 453.11253642799875,
	317.83295711060947, 454.0147915562627, 306.09480812641084, 454.0147915562627, 294.3566591422122,
	454.0147915562627, 282.6185101580136, 454.0147915562627, 270.8803611738149, 454.0147915562627,
	252.8216704288939, 454.0147915562627, 238.37471783295712, 454.0147915562627, 223.02483069977427,
	454.0147915562627, 204.0632054176072, 454.0147915562627, 195.93679458239276, 454.0147915562627,
	191.42212189616254, 454.91704668452667, 187.81038374717832, 457.62381206931843,
	184.19864559819413, 461.2328325823741, 168.8487584650113, 473.864404378069, 149.88713318284425,
	488.3004864302918, 143.56659142212192, 492.8117620716114, 142.66365688487585, 495.51852745640315,
	142.66365688487585, 498.2252928411949, 141.76072234762978, 502.7365684825146, 140.85778781038374,
	508.15009925209813, 139.9548532731377, 512.6613748934177, 139.05191873589166, 518.0749056630013,
	139.05191873589166, 521.683926176057, 139.9548532731377, 524.3906915608487, 142.66365688487585,
	527.0974569456405, 145.372460496614, 528.9019672021683, 147.17832957110608, 529.8042223304323,
	149.88713318284425, 531.6087325869601, 153.49887133182844, 534.3154979717518, 156.2076749435666,
	535.2177531000158, 159.8194130925508, 535.2177531000158, 165.2370203160271, 537.0222633565436,
	170.6546275395034, 539.7290287413355, 176.97516930022573, 541.5335389978633, 183.2957110609481,
	544.240304382655, 189.61625282167043, 546.0448146391828, 195.93679458239276, 546.9470697674468,
	202.25733634311513, 547.8493248957108, 209.4808126410835, 548.7515800239746, 217.60722347629797,
	549.6538351522386, 225.73363431151242, 549.6538351522386, 232.95711060948082, 549.6538351522386,
	240.1805869074492, 549.6538351522386, 249.2099322799097, 549.6538351522386, 261.8510158013544,
	549.6538351522386, 281.7155756207675, 550.5560902805025, 299.7742663656885, 551.4583454087664,
	313.31828442437927, 552.3606005370303, 326.86230248307, 553.2628556652943, 338.6004514672686,
	553.2628556652943, 350.33860045146724, 554.1651107935581, 363.882618510158, 555.9696210500861,
	379.23250564334086, 556.87187617835, 391.8735891647855, 556.87187617835, 401.8058690744921,
	557.774131306614, 409.0293453724605, 558.6763864348778, 412.64108352144467, 558.6763864348778,
	417.1557562076749, 558.6763864348778, 423.47629796839726, 556.87187617835, 427.9909706546275,
	552.3606005370303, 430.6997742663657, 544.240304382655, 432.5056433408578, 533.413242843488,
	434.31151241534985, 523.4884364325848, 435.21444695259595, 517.1726505347374, 435.21444695259595,
	510.8568646368899, 436.117381489842, 501.83431335425064, 437.02031602708803, 493.71401719987534,
	437.02031602708803, 485.59372104550005, 437.02031602708803, 473.864404378069, 433.40857787810387,
	460.3305774541102, 427.08803611738153, 451.30802617147094, 422.5733634311513, 444.99224027362345,
	419.8645598194131, 439.5787095040399, 417.1557562076749, 435.06743386272035, 412.64108352144467,
	429.6539030931368, 404.51467268623026, 422.43586206702537, 395.48532731376974, 414.3155659126501,
	388.2618510158013, 406.1952697582748, 381.038374717833, 399.8794838604273, 373.81489841986456,
	395.3682082191077, 365.68848758465015, 389.9546774495242, 354.85327313769756, 381.8343812951489,
	343.11512415349887, 373.71408514077353, 334.98871331828445, 370.10506462771787,
	331.37697516930024, 368.30055437119, 326.86230248307, 367.39829924292604, 321.4446952595937,
	368.30055437119, 315.12415349887135, 372.81183001250963, 306.09480812641084, 380.9321261668849,
	297.9683972911964, 389.0524223212602, 292.5507900677201, 398.0749736038995, 289.84198645598195,
	407.9997800148026, 288.9390519187359, 420.63135181049756, 288.9390519187359, 435.06743386272035,
	288.9390519187359, 445.8944954018874, 289.84198645598195, 454.91704668452667, 294.35665914221215,
	467.5486184802216, 298.8713318284424, 479.27793514765256, 301.5801354401806, 488.3004864302918,
	304.28893905191876, 499.1275479694589, 308.803611738149, 509.05235438036203, 313.3182844243792,
	518.9771607912652, 315.12415349887135, 529.8042223304323, 316.0270880361174, 538.8267736130715,
	316.0270880361174, 549.6538351522386, 316.0270880361174, 561.3831518196696, 312.4153498871332,
	569.5034479740449, 306.09480812641084, 576.7214890001562, 301.5801354401806, 580.330509513212,
	295.25959367945825, 581.2327646414758, 285.3273137697517, 582.1350197697398, 273.58916478555307,
	582.1350197697398, 263.65688487584646, 583.0372748980037, 253.72460496613996, 583.9395300262677,
	244.69525959367945, 583.9395300262677, 238.37471783295712, 583.9395300262677, 229.3453724604966,
	583.9395300262677, 214.8984198645598, 582.1350197697398, 198.6455981941309, 579.4282543849481,
	186.00451467268624, 575.8192338718924, 176.0722347629797, 569.5034479740449, 167.04288939051918,
	564.0899172044614, 158.91647855530476, 560.4808966914056, 150.7900677200903, 556.87187617835,
	141.76072234762978, 552.3606005370303, 133.63431151241537, 547.8493248957107, 129.1196388261851,
	545.142559510919, 126.41083521444695, 542.4357941261271, 120.0902934537246, 537.0222633565436,
	112.86681715575621, 530.7064774586961, 107.44920993227991, 524.3906915608487, 104.74040632054177,
	518.0749056630013, 103.83747178329571, 509.95460950862594, 101.12866817155756, 499.1275479694589,
	99.32279909706546, 488.3004864302918, 99.32279909706546, 476.5711697628608, 99.32279909706546,
	463.93959796716587, 99.32279909706546, 453.11253642799875, 99.32279909706546, 440.4809646323039,
	99.32279909706546, 427.84939283660896, 102.0316027088036, 415.21782104091403, 106.54627539503386,
	402.58624924521905, 110.15801354401805, 395.3682082191077, 113.76975169300226, 391.759187706052,
	116.47855530474041, 389.9546774495242, 120.0902934537246, 387.2479120647324, 127.313769751693,
	384.54114667994065, 135.44018058690745, 380.9321261668849, 140.85778781038374, 377.3231056538292,
	145.372460496614, 375.5185953973014, 148.9841986455982, 374.6163402690375, 152.5959367945824,
	372.81183001250963, 159.8194130925508, 368.30055437119, 168.8487584650113, 362.8870236016065,
	174.26636568848758, 359.2780030885508, 177.87810383747177, 357.4734928320229, 182.39277652370203,
	354.7667274472311, 184.20364559819413, 352.9572171907033,
];
const POINTS = positions.length / 2;
buffer.pushElement(positions, POINTS - 1, 2);
buffer.unshiftElement(positions, 0, 2);
const positionsDup = new Float32Array(buffer.duplicate(positions, 2));
const positionBuffer = regl.buffer({
	usage: "static",
	type: "float",
	length: (POINTS + 2) * 4 * FLOAT_BYTES,
	data: positionsDup,
});

const offset = new Array(POINTS * 2).fill().map((v, i) => 1 - (i % 2) * 2); // alternating [1, -1, 1, -1, etc]
const offsetBuffer = regl.buffer({
	usage: "static",
	type: "float",
	length: (POINTS + 2) * 2 * FLOAT_BYTES,
	data: offset,
});

const indices = lineMesh(POINTS);

// regl args
const attributes = {
	prevPos: {
		buffer: positionBuffer,
		offset: 0,
		stride: FLOAT_BYTES * 2,
	},
	currPos: {
		buffer: positionBuffer,
		offset: FLOAT_BYTES * 2 * 2,
		stride: FLOAT_BYTES * 2,
	},
	nextPos: {
		buffer: positionBuffer,
		offset: FLOAT_BYTES * 2 * 4,
		stride: FLOAT_BYTES * 2,
	},
	offset: offsetBuffer,
};

const uniforms = {
	aspect: ({ viewportWidth, viewportHeight }) => viewportWidth / viewportHeight,
	color: [0.5, 0, 0.5, 1],
	thickness: 1,
};

const elements = regl.elements({
	primitive: "triangles",
	usage: "static",
	type: "uint16",
	data: indices,
});

const vert = `
uniform float aspect;
uniform float thickness;
attribute vec2 prevPos;
attribute vec2 currPos;
attribute vec2 nextPos;
attribute float offset;
void main() {
  vec2 dir = normalize(nextPos - prevPos);
  vec2 normal = vec2(-dir.y, dir.x) * thickness;
  normal.x /= aspect;
  vec2 line = currPos + (normal * offset);
  line = line / vec2(400., -300.) + vec2(-1., 1.);
  gl_Position = vec4(line, 0., 1.);
}`;

const frag = `
precision mediump float;
uniform vec4 color;
void main() {
  gl_FragColor = color;
}`;

// render single frame
window.requestAnimationFrame(regl({ attributes, uniforms, elements, vert, frag }));
